## 二、系统模型与问题阐述

### A. 系统场景

考虑一个针对灾后应急响应的分层架构的空天地一体化网络（SAGIN）。该网络由地面设备层、低空中继层和空间计算层构成，旨在为地面基础设施瘫痪区域提供持续的边缘计算与通信服务。系统运行在一系列离散时隙上，表示为 $\mathcal{T} = \{1, 2, \dots, T\}$，每个时隙（Time Slot）的时长为 $\tau_0$ 秒。

#### 1) 地面层

地面层包含 $K$ 个分布在受灾区域的异构物联网（IoT）设备（如搜救传感器、受困者可穿戴设备），集合表示为 $\mathcal{K} = \{1, 2, \dots, K\}$。考虑灾后人员聚集特征，设备位置呈现出高度的空间非均匀性，采用托马斯簇过程（Thomas Cluster Process, TCP）对设备的空间分布进行建模：
假设灾区存在 $M$ 个随机分布的“热点”（如避难所或倒塌建筑），作为父节点。IoT 设备 $k$ 的水平坐标 $\mathbf{w}_k = [x_k, y_k]^T$ 服从以最近热点为中心的二维高斯分布 $\mathcal{N}(\mu_{hotspot}, \sigma_{tcp}^2)$。所有设备均配备单天线，且受限于电池容量和发射功率，无法直接与卫星通信，必须依赖无人机中继。

#### 2) 低空层

低空层部署了 $U$ 架旋翼无人机（UAV），集合为 $\mathcal{U} = \{1, 2, \dots, U\}$，作为移动中继网关。所有 UAV 维持在固定飞行高度 $H_u$。在任意时隙 $t$，UAV $u$ 的水平位置表示为 $\mathbf{q}_u(t) = [x_u(t), y_u(t)]^T$。

**UAV 移动性约束:**
UAV 的运动受最大飞行速度 $V_{\max}$ 限制。位置更新遵循一阶运动学模型：
$$
\mathbf{q}_u(t+1) = \mathbf{q}_u(t) + \mathbf{v}_u(t) \cdot \tau_0, \quad \forall u \in \mathcal{U}, t \in \mathcal{T}
$$
其中 $\mathbf{v}_u(t)$ 是 UAV 在 $t$ 时刻的速度控制矢量，受最大速度约束 $\|\mathbf{v}_u(t)\| \leq V_{\max}$。此外，为防止碰撞，任意两架 UAV 之间的距离需满足安全阈值 $d_{safe}$，即 $\|\mathbf{q}_u(t) - \mathbf{q}_{u'}(t)\| \geq d_{safe}, \forall u \neq u'$。

**推进能耗模型:**
相比于通信能耗，旋翼无人机的飞行推进能耗占据主导地位。为了精确刻画速度与能耗之间的非线性耦合关系，摒弃了简化的恒定功率模型，转而采用基于叶素动量理论（Blade Element Momentum Theory）的解析模型。 这种复杂的建模是必要的，因为旋翼机的功率曲线随速度呈现“U”型变化（悬停和高速飞行均由诱导阻力和寄生阻力导致高能耗），这引入了非平凡的速度控制权衡。UAV $u$ 在速度 $\|\mathbf{v}_u(t)\|$ 下的飞行功率 $P_u^{fly}(t)$ 建模为：
$$
P_u^{fly}(t) = P_0 \left( 1 + \frac{3 \|\mathbf{v}_u(t)\|^2}{U_{tip}^2} \right) + P_i \left( \sqrt{1 + \frac{\|\mathbf{v}_u(t)\|^4}{4 v_0^4}} - \frac{\|\mathbf{v}_u(t)\|^2}{2 v_0^2} \right)^{1/2} + \frac{1}{2} d_0 \rho s A \|\mathbf{v}_u(t)\|^3
$$
此处，$P_0$ 为叶片轮廓功率，$P_i$ 为诱导功率，$U_{tip}$ 为叶尖速度，$v_0$ 为悬停诱导速度，$d_0$、$\rho$、$s$、$A$ 分别为机身阻力系数、空气密度、旋翼实度及旋翼盘面积。
UAV 的电池能量状态 $E_u(t)$ 随时间演变为：
$$
E_u(t+1) = E_u(t) - \left( P_u^{fly}(t) + P_u^{comm}(t) \right) \cdot \tau_0
$$
系统必须确保 $E_u(t) \geq 0$。

#### 3) 空间层

空间层由 $L$ 颗低轨（LEO）卫星组成，集合为 $\mathcal{L} = \{1, 2, \dots, L\}$，轨道高度为 $H_s$。卫星作为计算节点。

**轨道动力学:**
卫星网络采用 **Walker Delta** 星座构型。假设卫星在高度为 $H_s$ 的圆形轨道上运行，其角速度为 $\omega_s = \sqrt{\mu_E / (R_E + H_s)^3}$，其中 $\mu_E$ 为地球引力常数，$R_E$ 为地球半径。每个时隙 $t$ 卫星在地心地固坐标系（ECEF）下的三维坐标为 $\mathbf{s}_l(t) = [x_l(t), y_l(t), z_l(t)]^T$。

**可见性窗口 (Visibility Window):**
为精确计算星地链路的通断，我们将 UAV 的局部坐标 $\mathbf{q}_u(t)$ 映射到与卫星一致的 ECEF 坐标系中，记为 $\mathbf{q}_u^{ECEF}(t)$。令 $R_E$ 表示地球平均半径。基于 UAV 的飞行高度 $H_u$ 和卫星轨道高度 $H_s$，两者距地心的距离分别定义为 $r_u = R_E + H_u$ 与 $r_s = R_E + H_s$。

在任意时隙 $t$，UAV $u$ 与卫星 $l$ 之间的瞬时距离表示为 $d_{u,l}(t) = \|\mathbf{s}_l(t) - \mathbf{q}_u^{ECEF}(t)\|$。UAV $u$ 对卫星 $l$ 的仰角 $\theta_{u,l}(t)$ 推导如下：

$$
\theta_{u,l}(t) = \arcsin \left( \frac{r_s^2 - r_u^2 - d_{u,l}^2(t)}{2 r_u d_{u,l}(t)} \right)
$$

卫星 $l$ 对 UAV $u$ 的可见性由二进制变量 $\alpha_{u,l}(t)$ 描述：
$$
\alpha_{u,l}(t) = \mathbb{I}\left( \theta_{u,l}(t) \geq \theta_{min} \right)
$$
其中 $\mathbb{I}(\cdot)$ 为示性函数，$\theta_{min}$ 为最小仰角阈值。设定该阈值（通常为 $10^\circ \sim 15^\circ$）是为了规避地表复杂环境造成的视线遮挡及低仰角下的严重大气衰减。

## B. 通信模型

考虑到 UAV 作为中继的特性，数据传输被解耦为两条独立的物理链路：地面-无人机接入链路与无人机-卫星回程链路。

### 1) 地面-无人机接入信道

由于灾后环境存在大量倒塌建筑与废墟，地面设备（GU）与 UAV 之间的视线（LoS）路径极易受阻。采用概率视距模型（Probabilistic LoS Model）来刻画这种环境特征。

在时隙 $t$，GU $k$ 与 UAV $u$ 的仰角为 $\phi_{k,u}(t) = \arcsin (H_u / d_{k,u}(t))$，其中 $d_{k,u}(t)$ 为 3D 欧氏距离。LoS 路径存在的概率 $P_{LoS}(\phi_{k,u})$ 为：
$$
P_{LoS}(\phi_{k,u}(t)) = \frac{1}{1 + a \cdot \exp(-b [\phi_{k,u}(t) - a])}
$$
其中 $a, b$ 为环境拟合常数。平均路径损耗 $PL_{k,u}(t)$（dB）为 LoS 与 NLoS 状态的期望值：
$$
PL_{k,u}(t) = P_{LoS}(t) \cdot \left( \xi_{LoS} + 20\log_{10} d_{k,u}(t) \right) + (1 - P_{LoS}(t)) \cdot \left( \xi_{NLoS} + 20\log_{10} d_{k,u}(t) \right)
$$
其中 $\xi_{LoS/NLoS}$ 包含了自由空间损耗常数及对应状态下的穿透损耗。

考虑到无人机的低空优势，信道呈现Rician 衰落特性。复信道系数 $\tilde{h}_{k,u}(t)$ 建模为确定性 LoS 分量与随机散射分量的叠加：
$$
\tilde{h}_{k,u}(t) = \sqrt{10^{-PL_{k,u}(t)/10}} \cdot \left( \sqrt{\frac{K_r}{K_r+1}} \bar{h}_{LoS}(t) + \sqrt{\frac{1}{K_r+1}} \hat{h}_{scat}(t) \right)
$$
其中，$K_r$ 为莱斯因子（Rician Factor），$\bar{h}_{LoS}(t) = e^{-j 2\pi d_{k,u}(t)/\lambda}$ 为相位相干的直射分量，$\hat{h}_{scat}(t) \sim \mathcal{CN}(0, 1)$ 为服从复高斯分布的散射分量。

**用户关联机制 :**
地面设备根据瞬时信道质量选择接入点。在时隙 $t$，设备 $k$ 关联至提供最大平均接收功率的 UAV。因此，关联到 UAV $u$ 的用户集合 $\mathcal{K}_u(t)$ 定义为：
$$
\mathcal{K}_u(t) = \left\{ k \in \mathcal{K} \mid u = \arg\max_{u' \in \mathcal{U}} PL_{k,u'}(t), \text{ and } PL_{k,u}(t) \le PL_{th} \right\}
$$
其中 $PL_{th}$ 为最大允许路径损耗阈值（由接收机灵敏度决定）。若设备 $k$ 周围无满足阈值的 UAV，则处于中断状态。该机制表明，UAV 的轨迹 $\mathbf{q}_u(t)$ 动态改变了拓扑结构及关联集合 $\mathcal{K}_u(t)$，进而影响负载分布。

### 2) 无人机-卫星回程信道

回程链路工作在Ka 波段。影响该链路信道质量的两个主要因素分别是大气衰减与由高速相对运动引发的多普勒频移（Doppler Shift）。

**大尺度衰落与大气损耗：**
UAV $u$ 与卫星 $l$ 之间的信道功率增益 $g_{u,l}(t)$ 主要受大尺度自由空间损耗与大气吸收影响：
$$
g_{u,l}(t) = G_{u}^{tx} G_{sat}^{rx} \left( \frac{c}{4\pi f_c d_{u,l}(t)} \right)^2 \cdot 10^{-L_{atm}(\theta_{u,l})/10}
$$
其中，$G_{u}^{tx}$ 和 $G_{sat}^{rx}$ 分别为 UAV 发射天线与卫星接收天线的定向增益。$L_{atm}(\theta_{u,l})$ 为依赖于仰角的大气衰减（包含气体吸收与云雾衰减）。

**多普勒效应与 SNR 恶化：**
由于卫星的高速运动，链路存在显著的多普勒频移。基于 ECEF 坐标系下的相对速度，频移量 $\nu_{u,l}(t)$ 为：
$$
\nu_{u,l}(t) = \frac{f_c}{c} \cdot \frac{(\mathbf{v}_l(t) - \mathbf{v}_u^{ECEF}(t))^T (\mathbf{s}_l(t) - \mathbf{q}_u^{ECEF}(t))}{\|\mathbf{s}_l(t) - \mathbf{q}_u^{ECEF}(t)\|}
$$
依据 5G 非地面网络（NTN）标准，假设回程链路在物理层采用 OFDM 波形以支持高频谱效率传输。高速运动导致的多普勒频移会破坏子载波间的正交性，产生载波间干扰（ICI）。这种物理损伤被建模为有效信噪比（SNR）的衰减因子 $\chi(\nu_{u,l}) \in (0,1]$：
$$
\chi(\nu_{u,l}(t)) = \text{sinc}^2 \left( \frac{\nu_{u,l}(t)}{\Delta f_{sub}} \right)
$$
其中 $\Delta f_{sub}$ 为 OFDM 子载波间隔。该公式表明，相对运动速度越大，$\nu_{u,l}$ 越大，导致 $\chi$ 下降，通信质量恶化。

### 3) 传输速率与中继约束

**接入链路速率：**
假设 UAV 采用正交频分多址（OFDMA）技术。UAV $u$ 为关联的 GU $k$ 分配带宽比例 $\beta_{k,u}(t)$。根据香农公式，上行链路速率为：
$$
R_{k,u}^{acc}(t) = \beta_{k,u}(t) B_{acc} \log_2 \left( 1 + \frac{P_k^{tx} |\tilde{h}_{k,u}(t)|^2}{N_0 B_{acc} + I_{k,u}^{inter}(t)} \right)
$$
其中 $P_k^{tx}$ 为 GU 发射功率，$N_0$ 为噪声功率谱密度，$I_{k,u}^{inter}(t)$ 表示来自非关联用户的同频干扰。假设所有 UAV 复用同一频段以最大化频谱效率，该干扰项建模为：
$$
I_{k,u}^{inter}(t) = \sum_{u' \in \mathcal{U}, u' \neq u} \sum_{j \in \mathcal{K}_{u'}(t)} P_j^{tx} |\tilde{h}_{j,u}(t)|^2
$$
其中 $\mathcal{K}_{u'}(t)$ 表示在时隙 $t$ 关联至邻近无人机 $u'$ 的用户集合，该项反映了多无人机复用同一频段带来的同频干扰。

**回程链路速率与约束：**

定义二进制决策变量 $\zeta_{u,l}(t) \in \{0, 1\}$，表示在时隙 $t$ 无人机 $u$ 是否选择连接卫星 $l$。
该决策受限于以下物理约束：
1.  **卫星可见性：** 仅当链路物理可见时方可连接，即 $\zeta_{u,l}(t) \leq \alpha_{u,l}(t)$。
2.  **射频链路数量约束：** 受限于无人机的载荷重量与天线孔径，假设每架 UAV 仅配备 $N_{RF}$ 套卫星通信收发机，意味着同一时刻 UAV 最多只能与 $N_{RF}$ 颗卫星建立高频回程链路：
    $$
    \sum_{l \in \mathcal{L}} \zeta_{u,l}(t) \leq N_{RF}, \quad \forall u \in \mathcal{U}
    $$

与接入链路不同，UAV 在回程链路中作为用户终端，无法直接控制带宽分配。我们假设卫星网络在 MAC 层采用按需分配多址（Demand-Assigned Multiple Access, DAMA）机制。在数学建模中，这被简化为卫星 $l$ 将其总带宽 $B_{sat}^{total}$ 在当前所有关联的 UAV 之间进行动态公平分配。因此，UAV $u$ 获得的实际回程带宽 $B_{u,l}^{back}(t)$ 由环境状态决定：
 $$
 B_{u,l}^{back}(t) = \frac{B_{sat}^{total}}{\sum_{u' \in \mathcal{U}} \zeta_{u',l}(t)}
 $$
 这一机制意味着，UAV 的卫星选择决策 $\zeta_{u,l}$ 会改变卫星的负载分布，进而通过上述公式反作用于自身及其他 UAV 的传输速率，形成竞争关系。

在该分配到的带宽 $B_{u,l}^{back}(t)$ 上，UAV 采用 OFDM 调制进行数据传输，结合卫星选择策略与多普勒效应，UAV $u$ 的总回程聚合速率 $R_{u}^{back}(t)$ 为：
$$
R_{u}^{back}(t) = \sum_{l \in \mathcal{L}} \zeta_{u,l}(t) \cdot B_{u,l}^{back}(t) \log_2 \left( 1 + \frac{P_{tx}^{link} g_{u,l}(t) \cdot \chi(\nu_{u,l}(t))}{N_0 B_{u,l}^{back}(t)} \right)
$$

**约束条件：**
1.  **可见性约束：** $\alpha_{u,l}(t) \in \{0,1\}$ 取决于仰角是否满足 $\theta_{u,l}(t) \geq \theta_{min}$。
2.  **功率约束：** 通信功率 $P_u^{comm}(t)$ 被建模为由卫星关联动作直接驱动的射频发射功率之和。假设为保障链路的信噪比要求，UAV 需为每一条建立的星地链路分配固定的发射功率 $P_{tx}^{link}$，则总通信功率为：
$$
P_u^{comm}(t) = P_{tx}^{link} \cdot \sum_{l \in \mathcal{L}} \zeta_{u,l}(t)
$$
3.  **多普勒容限约束：** 考虑到卫星通信接收机锁相环（PLL）的物理捕获范围限制，如果瞬时频移超过接收机最大容限 $\nu_{max}$，链路将发生失锁中断。因此，实际传输速率修正为：
    $$
    \hat{R}_{u,l}^{back}(t) = \begin{cases}
    R_{u,l}^{back}(t), & \text{if } |\nu_{u,l}(t)| \leq \nu_{max} \\
    0, & \text{otherwise}
    \end{cases}
    $$
    
## C. 任务处理模型

本节基于宏观流式到达，微观成块处理的混合特征构建任务模型。系统采用时隙化架构，在每个时隙 $\tau_0$ 内，将到达的随机任务流截断为一个批次进行调度，从而将连续的物理过程转化为离散的排队动力学。

### 1) 任务生成模型

**宏观流式到达**
在灾难应急环境中，地面物联网设备（GU）的任务到达呈现高度的时间突发性。我们假设每个地面设备 $k \in \mathcal{K}$ 的任务产生服从非齐次泊松过程 (Non-homogeneous Poisson Process, NHPP)。在时隙 $t$ 内，任务到达率为 $\lambda_k(t)$，反映了搜救现场流量随灾情演进的动态变化。

**微观成块到达：**
地面物联网设备（GU）产生的计算任务具有原子性（Atomicity）。在时隙 $t$，设备 $k$ 产生的新任务批次被封装为元组 $\Phi_k(t) \triangleq \{ D_k(t), C_k(t), \tau_k^{max} \}$。其中 $D_k(t)$ 表示该批次任务的数据总量（bits）。

**地面缓冲区动态：**
由于无线信道容量限制，新产生的任务块往往无法在当前时隙完全传出。因此，我们定义 $Q_k^{gu}(t)$ 为地面设备 $k$ 本地缓冲区的任务积压量。该队列的演化遵循成块注入，流式流出的规则：
$$
Q_k^{gu}(t+1) = \min \left\{ [Q_k^{gu}(t) + \underbrace{D_k(t)}_{\text{Block Arrival}} - \underbrace{R_{k,u}^{acc}(t)\tau_0}_{\text{Stream Depature}}]^+ , Q_{max}^{GU} \right\}
$$
*   **Block Arrival:** 新任务以块的形式瞬时加入队列。
*   **Stream Departure:** 根据接入链路速率 $R_{k,u}^{acc}(t)$，从队列中切分出一个数据子块进行传输。这在数学上体现为部分卸载机制。
*   **物理含义：** $Q_k^{gu}(t)$ 反映了地面用户的卸载紧迫程度，是 UAV 进行带宽分配决策的关键依据。

### 2) 无人机中继排队机制

UAV $u \in \mathcal{U}$ 充当存储-转发节点。其核心挑战在于解决接入链路速率 $R_{acc}$ 与回程链路速率 $R_{back}$ 之间的速率失配。由于采用部分卸载（Partial Offloading）协议，任务批次被视为准连续流进入缓冲区。

定义 $Q_u^{relay}(t)$ 为 UAV $u$ 在时隙 $t$ 初的数据缓冲区积压量（bits）。其状态更新为：
$$
Q_u^{relay}(t+1) = \min \left\{ \left[ Q_u^{relay}(t) + \underbrace{\sum_{k \in \mathcal{K}_u} \min(Q_k^{gu}(t), R_{k,u}^{acc}(t)\tau_0)}_{\text{Inflow from GU}} - \underbrace{R_{u}^{back}(t)\tau_0}_{\text{Outflow to Sat}} \right]^+, Q_{max}^{UAV} \right\}
$$
*   **Inflow from GU:** 地面设备实际成功传输的数据量。$\min(Q_k^{gu}, R\tau_0)$ 表示实际传输量受限于“待传数据量”和“信道容量”两者的较小值。$\mathcal{K}_u$ 是当前关联的用户集合。
*   **Outflow to Sat:** 传输至卫星数据量，$R_{u}^{back}(t)$ 是考虑了多普勒约束后的有效聚合回程速率。

将微观元组中的 $\tau_k^{max}$ 映射为宏观队列的软阈值约束。
定义拥塞阈值 $Q_{th} \approx \bar{R}_{out} \cdot \bar{\tau}^{max}$。当 $Q_u^{relay}(t) > Q_{th}$ 时，意味着缓冲区内的平均排队时间在统计上已超过任务容忍时延，系统进入“拥塞失效”状态。

**溢出与丢包：**
若缓冲区积压超过物理容量 $Q_{max}^{UAV}$，将发生数据溢出。丢弃的数据量 $D_{u}^{drop}(t)$ 定义为：
$$
D_{u}^{drop}(t) = \max \left\{ 0, Q_u^{relay}(t) + \text{Inflow} - \text{Outflow} - Q_{max}^{UAV} \right\}
$$

### 3) 卫星边缘计算模型

低轨卫星 $l \in \mathcal{L}$ 作为边缘计算节点。设 $Q_l^{comp}(t)$ 为卫星 $l$ 的计算任务队列积压量（bits）。在时隙 $t$，卫星接收到的数据量等于所有连接 UAV 的成功卸载量之和。

卫星计算队列 $Q_l^{comp}(t)$（单位：bits）的演化为：
$$
Q_l^{comp}(t+1) = \left[ Q_l^{comp}(t) + \underbrace{\sum_{u} \zeta_{u,l}(t) R_{u}^{back}(t)\tau_0}_{\text{Offloaded Data}} - \underbrace{\frac{F_{sat}}{\bar{C}(t)} \tau_0}_{\text{Processed Data}} \right]^+
$$
其中：
*   $\zeta_{u,l}(t)$ 是 UAV $u$ 对卫星 $l$ 的关联变量。
*   $F_{sat}$ 是卫星的总 CPU 频率（cycles/s）。
*   $\bar{C}(t)$ 是当前汇聚任务流的加权平均计算密度（cycles/bit），由元组参数 $C_k(t)$ 决定。
*   计算密集型任务（高 $C_k$）会显著降低卫星的数据吞吐率，进而导致队列积压。

### 4) 端到端时延分析

对于任意任务 $\Phi_k(t)$，其端到端时延 $T_{total}$ 由四个解耦的物理过程组成：
$$
T_{total} \approx T_{acc} + T_{relay} + T_{prop} + T_{comp}
$$
1.  **接入传输时延 ($T_{acc}$):** $D_k(t)/R_{k,u}^{acc}(t)$，取决于地面信道质量。
2.  **中继排队时延 ($T_{relay}$):** 数据在 UAV 缓冲区滞留的时间。
3.  **传播时延 ($T_{prop}$):** 信号往返星地链路的物理时间。
4.  **卫星计算时延 ($T_{comp}$):** 包含在卫星队列的等待时间及 CPU 执行时间。

直接追踪每个数据包的精确时延在数学上是极其困难的。基于排队论中的利特尔法则（Little's Law），平均排队时延与平均队列长度成正比。因此，在后续的马尔可夫决策过程（MDP）建模中，我们将最小化系统平均时延的目标转化为最小化全网队列积压：
$$
\min \lim_{T \to \infty} \frac{1}{T} \sum_{t=1}^T \left( \sum_{k} Q_k^{gu}(t) + \sum_{u} Q_u^{relay}(t) + \sum_{l} Q_l^{comp}(t) \right)
$$

## D. 问题建模与 MDP 构建

在此，我们将物理场景形式化为数学规划问题，并针对多无人机协同环境将其转化为去中心化部分可观测马尔可夫决策过程（Dec-POMDP）。

### 1) 全局优化问题构建

我们的目标是在满足移动性、能量及通信链路约束的前提下，最小化系统的长期平均加权成本。该成本由全网任务队列积压量（作为端到端时延的代理变量）与系统能耗构成。

**目标函数:**
系统总成本由两部分组成：1) **全网任务队列积压**（作为端到端时延的有效代理变量）；2) **全系统能耗**（包含 UAV 推进与通信能耗）。
$$
\min_{\boldsymbol{\pi}} \lim_{T \to \infty} \frac{1}{T} \mathbb{E} \left[ \sum_{t=1}^{T} \left( \omega_{Q} \frac{Q_{total}(t)}{\mathcal{Q}_{scale}} + \omega_{E} \frac{E_{sys}(t)}{\mathcal{E}_{scale}} \right) \right]
$$
其中：
*   $Q_{total}(t) = \sum_{k} Q_k^{gu}(t) + \sum_{u} Q_u^{relay}(t) + \sum_{l} Q_l^{comp}(t)$。全网任务队列积压量。
*   $E_{sys}(t) = \sum_{u} \left( P_u^{fly}(t) + P_u^{comm}(t) \right) \cdot \tau_0 $。
*   $\mathcal{Q}_{scale} = Q_{max}^{UAV}$，$\mathcal{E}_{scale} = P_{max}^{UAV}\tau_0$ 为归一化因子。

**约束条件:**
*   **C1 (UAV 运动约束):** $\|\mathbf{a}_u(t)\| \le A_{max}$，$\|\mathbf{v}_u(t)\| \le V_{max}$，且防碰撞满足 $\|\mathbf{q}_u(t) - \mathbf{q}_{u'}(t)\| \ge d_{safe}$。
*   **C2 (UAV 能量约束):** $E_u(t) \ge 0, \forall t$。
*   **C3 (链路数量与可见性约束):** 每个 UAV 同时连接的卫星数量受限于射频链路数 $N_{RF}$：$\sum_{l} \zeta_{u,l}(t) \le N_{RF}$，且 $\zeta_{u,l}(t) \le \alpha_{u,l}(t)$。
*   **C4 (多普勒频移约束):**  通信链路需满足多普勒频移限制 $|\nu_{u,l}(t)| \le \nu_{max}$，否则链路中断。
*   **C5 (任务时延硬约束):** 将任务元组中的 $\tau_k^{max}$ 转化为各级队列的拥塞阈值。
     *   对于地面队列：若 $Q_k^{gu}(t) > Q_{th}^{gu}$，判定源端拥塞超时。
     *   对于中继队列：若 $Q_u^{relay}(t) > Q_{th}^{relay}$，判定中继拥塞超时。
     这构成了多级丢包判定机制，任何一级的滞留过久都会导致任务失效。
*   **C6 (队列稳定性约束):** 系统需满足李雅普诺夫稳定性，即 $\lim_{T \to \infty} \mathbb{E}[Q_{total}(T)] < \infty$。
*   **C7 (接入带宽约束):** $\sum_{k \in \mathcal{K}_u} \beta_{u,k}(t) B_{acc}^{total} \le B_{acc}^{available}$。

**问题性质：** 该问题属于典型的混合整数非线性规划（MINLP）。由于卫星拓扑的高度动态性和任务到达的随机性，传统优化方法（如凸优化或启发式算法）难以在毫秒级时隙内求得最优解。因此，我们采用多智能体深度强化学习（MADRL）方法进行实时决策。

### 2) Dec-POMDP 建模

针对多无人机协同边缘计算场景的动态拓扑与局部感知特性，我们将系统优化问题建模为去中心化部分可观测马尔可夫决策过程（Dec-POMDP）。该过程由元组 $\mathcal{M} = \langle \mathcal{N}, \mathcal{S}, \mathcal{O}, \mathcal{A}, \mathcal{P}, \mathcal{R}, \gamma \rangle$ 定义。

各元素定义如下：
*   $\mathcal{N} = \{1, 2, \dots, U\}$ 表示智能体集合，对应系统中的 $U$ 架无人机中继。
*   $\mathcal{S}$ 表示全局状态空间，包含全网所有节点（地面设备、UAV、卫星）的物理位置、信道状态及队列积压等完整环境信息。
*   $\mathcal{O} = \times_{u \in \mathcal{N}} O_u$ 表示联合观测空间，其中 $O_u$ 为单个 UAV 的局部观测空间，仅包含其感知范围内的部分环境特征。
*   $\mathcal{A} = \times_{u \in \mathcal{N}} A_u$ 表示联合动作空间，其中 $A_u$ 为单个 UAV 的动作空间，包含机动控制、带宽分配与关联决策。
*   $\mathcal{P}: \mathcal{S} \times \mathcal{A} \times \mathcal{S} \to [0, 1]$ 表示状态转移概率函数。它刻画了在当前联合动作下，系统从状态 $s$ 转移到 $s'$ 的概率，涵盖了 UAV/卫星的运动学更新、无线信道的随机衰落以及任务队列的动态演化过程。
*   $\mathcal{R}: \mathcal{S} \times \mathcal{A} \to \mathbb{R}$ 表示全局奖励函数。系统根据联合状态和动作反馈一个标量奖励，旨在引导智能体协同最小化全网时延与能耗。
*   $\gamma \in [0, 1)$ 表示折扣因子，用于权衡即时奖励与长期累积收益的重要性。

为了提升训练效率并适应不同规模的网络，我们采用集中式训练-分布式执行（CTDE）架构。在执行阶段，每个 UAV 仅根据局部观测 $o_u \in O_u$ 独立决策；而在训练阶段，Critic 网络利用全局状态 $s \in \mathcal{S}$ 进行价值评估。
对不同智能体，采用参数共享机制，即所有 UAV 智能体共用同一套策略网络参数。

#### a) 全局状态空间 ($\mathcal{S}$)

全局状态 $s_t$ 包含环境中所有实体的完整信息。在集中式训练-分布式执行（CTDE）架构中，$s_t$ 仅在训练阶段用于 Critic 网络评估联合动作的价值，而在执行阶段不可见。全局状态定义为全网实体的集合：

$$
s_t = \{ \mathbf{S}_{UAV}(t), \mathbf{S}_{GU}(t), \mathbf{S}_{SAT}(t) \}
$$

*   **UAV 全局状态 ($\mathbf{S}_{UAV}$):** 包含所有 $U$ 架无人机的绝对位置、速度、剩余能量及缓冲区积压状态。
*   **GU 全局状态 ($\mathbf{S}_{GU}$):** 包含所有 $K$ 个地面设备的绝对坐标及实时任务积压量 $Q_k^{gu}(t)$。
    *   *注：Critic 网络需感知全网用户（包括未被覆盖的盲区用户），以准确评估系统因服务中断产生的潜在惩罚。*
*   **SAT 全局状态 ($\mathbf{S}_{SAT}$):** 包含所有 $L$ 颗卫星的轨道参数（位置、速度）及当前的计算负载 $Q_l^{comp}(t)$。

#### b) 局部观测空间 ($\mathcal{O}$)

由于通信距离与感知能力的限制，每个 UAV 仅能获取局部环境信息。为了解决输入维度随周围节点数量动态变化的问题，并赋予策略对相对位置的平移不变性，设计了如下观测结构。
UAV $u$ 在时隙 $t$ 的局部观测 $o_u(t)$ 由自身状态向量与三个变长特征集合组成：

$$
o_u(t) = \left\{ \mathbf{o}_{u}^{own}(t), \mathcal{O}_{u}^{users}(t), \mathcal{O}_{u}^{sats}(t), \mathcal{O}_{u}^{nbrs}(t) \right\}
$$

**1. 自身特征 ($\mathbf{o}_{u}^{own}$):**
包含归一化的自身物理与资源状态：
$$
\mathbf{o}_{u}^{own}(t) = \left[ \frac{\mathbf{q}_u(t)}{L_{map}}, \frac{\mathbf{v}_u(t)}{V_{max}}, \frac{E_u(t)}{E_{init}}, \frac{Q_u^{relay}(t)}{Q_{max}^{UAV}} \right]
$$

**2. 候选用户特征集合 ($\mathcal{O}_{u}^{users}$):**
定义 $\mathcal{K}_u(t)$ 为当前时刻根据最大接收功率准则（Max-RSSI）物理连接到 UAV $u$ 的候选用户集合。对于该集合中的任意用户 $k \in \mathcal{K}_u(t)$，提取特征向量 $\boldsymbol{\phi}_{k}^{gu}(t)$：
$$
\boldsymbol{\phi}_{k}^{gu}(t) = \left[ \underbrace{\mathbf{w}_k - \mathbf{q}_u(t)}_{\text{相对位置}}, \underbrace{Q_k^{gu}(t)}_{\text{任务积压}}, \underbrace{\eta_{k,u}(t)}_{\text{频谱效率}}, \underbrace{\mathbb{I}_{k}^{last}(t)}_{\text{关联历史}} \right]
$$
*   **相对位置：** 使用相对于 UAV 的局部坐标，确保几何特征的泛化性。
*   **频谱效率 (SE, $\eta_{k,u}$):** $\eta_{k,u}(t) = \log_2(1 + \text{SINR}_{k,u}(t))$。该项显式表征了当前物理信道在单位带宽下的传输潜能，能够直接指导智能体的带宽分配决策，避免神经网络重复学习复杂的香农公式。
*   **关联历史 ($\mathbb{I}_{k}^{last}$):** 二值指示变量，若上一时隙该用户也关联在 UAV $u$，则为 1。这有助于策略学习时间连续性，减少频繁切换。

**3. 可见卫星特征集合 ($\mathcal{O}_{u}^{sats}$):**
仅包含视线范围内 ($\alpha_{u,l}=1$) 且满足最小仰角的卫星。对于卫星 $l$，提取特征 $\boldsymbol{\phi}_{l}^{sat}(t)$：
$$
\boldsymbol{\phi}_{l}^{sat}(t) = \left[ \mathbf{s}_l(t) - \mathbf{q}_u^{ECEF}(t), \mathbf{v}_l(t) - \mathbf{v}_u^{ECEF}(t), \nu_{u,l}(t), \text{SNR}_{u,l}^{eff}(t), Q_l^{comp}(t) \right]
$$
*   **有效信噪比 ($\text{SNR}_{u,l}^{eff}$):** 综合了自由空间损耗与多普勒频移造成的信号衰减。该特征直接反映了回程链路的可用性，帮助智能体规避多普勒频移过大（即将失锁）的卫星。
*   **多普勒频移 ($\nu_{u,l}$):** 显式输入频移值，用于辅助判断链路稳定性。

**4. 邻居感知集合 ($\mathcal{O}_{u}^{nbrs}$):**
包含感知半径 $R_{sense}$ 内的其他 UAV，用于协同避障。特征为相对位置与相对速度：
$$
\boldsymbol{\phi}_{u'}^{nbr}(t) = \left[ \mathbf{q}_{u'}(t) - \mathbf{q}_u(t), \mathbf{v}_{u'}(t) - \mathbf{v}_u(t) \right], \quad \forall u' \in \mathcal{N}_u(t)
$$

**状态编码说明：** 针对上述变长集合（Users, Sats, Neighbors），在具体的网络实现中，采用注意力机制将其聚合为固定长度的特征向量，随后通过GRU（门控循环单元）处理时间序列信息，以解决部分可观测性对历史信息的依赖。

#### c) 动作空间 ($\mathcal{A}$)

动作空间包含机动控制、带宽调度与卫星关联三个维度的联合决策。针对变长的候选用户队列，引入最大填充与动作掩码(Action Masking)机制。

$$
a_u(t) = \{ \hat{\mathbf{a}}_{acc}(t), \boldsymbol{\beta}_{u}(t), \boldsymbol{\zeta}_{u}(t) \}
$$

**1. 连续机动控制 ($\hat{\mathbf{a}}_{acc}$):**
输出 $\in [-1, 1]^2$，分别控制水平面的两个正交加速度分量，经缩放后得到实际加速度向量 $\mathbf{a}_u(t)$。

**2. 接入带宽分配 ($\boldsymbol{\beta}_{u}$):**
设 UAV 在物理层支持的最大并发用户数为 $K_{max}$（受限于子载波资源）。网络输出固定长度为 $K_{max}$ 的权重向量 $\mathbf{z}_{bw}$。
*   **动作掩码：** 根据当前实际候选用户数 $|\mathcal{K}_u(t)|$，生成掩码向量 $\mathbf{m} \in \{0, 1\}^{K_{max}}$（前 $|\mathcal{K}_u|$ 位为 1，其余为 0）。
*   **Softmax 分配：** 动作向量 $\mathbf{z}_{bw}$ 经过 Softmax 及掩码处理后，映射为物理层的带宽分配系数 $\beta_{k,u}(t)$，满足 $\sum_{k \in \mathcal{K}_u} \beta_{k,u}(t) \le 1$。结合掩码计算实际带宽比例，确保无效用户的分配权重为 0：
    $$
    \beta_{u,k}(t) = \frac{e^{z_{bw, k}} \cdot m_k}{\sum_{j=1}^{K_{max}} e^{z_{bw, j}} \cdot m_j}
    $$

**3. 卫星关联决策 ($\boldsymbol{\zeta}_{u}$):**
输出针对所有可见卫星的偏好分数。
*   **约束处理：** 同样应用掩码技术，屏蔽掉那些多普勒频移超限 ($|\nu| > \nu_{max}$) 或计算队列过载的卫星（Logits 置为 $-\infty$）。
*   **Top-K 选择：** 从有效卫星中选择分数最高的 $N_{RF}$ 颗建立连接。

#### 3) 奖励函数设计

为了避免队列饱和导致的奖励梯度消失，并显式鼓励服务能力，采用“服务量归一化 + 丢包量归一化 + 平滑队列惩罚 + 队列变化 + 动作平滑惩罚”的奖励设计。系统目标是在满足物理约束的前提下，提高接入服务能力并抑制任务积压与丢包。

**a) 约束违规惩罚 ($\Psi_{fail}$):**
当 UAV 发生碰撞（间距小于 $d_{safe}$）或能量耗尽时，施加严重惩罚：
$$
\Psi_{fail}(t) = \begin{cases}
-\eta_{crash}, & \text{if } \exists u': \|\mathbf{q}_u - \mathbf{q}_{u'}\| < d_{safe} \\
-\eta_{batt}, & \text{if } E_u(t+1) < 0 \\
0, & \text{otherwise}
\end{cases}
$$

**b) 服务量与丢包量归一化:**
定义全网到达、服务与丢包总量：
$$
A(t) = \sum_{k=1}^{K} A_k(t), \quad S(t) = \sum_{k=1}^{K} S_k(t), \quad D(t) = \sum_{k=1}^{K} D_k^{drop}(t) + \sum_{u=1}^{U} D_u^{drop}(t)
$$
为稳定奖励尺度，引入期望到达量作为归一化尺度：
$$
A_{scale} = \lambda \cdot K \cdot \tau_0
$$
归一化服务量与丢包量定义为：
$$
S_{norm}(t) = \frac{S(t)}{A_{scale} + \epsilon}, \quad
D_{norm}(t) = \frac{D(t)}{A_{scale} + \epsilon}
$$

**c) 队列水平惩罚:**
定义全网总队列与归一化惩罚项：
$$
Q_{tot}(t)=\sum_{k=1}^{K}Q_k^{gu}(t)+\sum_{u=1}^{U}Q_u^{relay}(t)+\sum_{l=1}^{L}Q_l^{comp}(t)
$$
$$
Q_{max}^{tot}=K\cdot Q_{max}^{GU}+U\cdot Q_{max}^{UAV}+L\cdot Q_{max}^{SAT}
$$
$$
r_{queue}(t) = \log\left(1 + \frac{Q_{tot}(t)}{Q_{max}^{tot} + \epsilon}\right)
$$
（可选）若需可调的平滑强度，可采用
$$
r_{queue}(t)=\frac{\log\left(1+k\cdot Q_{tot}(t)/Q_{max}^{tot}\right)}{\log(1+k)}
$$

**d) 队列变化项:**
为提升可学性，引入队列下降奖励：
$$
\Delta Q(t) = \text{clip}\left(\frac{Q_{tot}(t-1) - Q_{tot}(t)}{Q_{max}^{tot} + \epsilon},\ -1,\ 1\right)
$$

**e) 动作平滑惩罚:**
为抑制剧烈机动带来的训练不稳定，加入加速度惩罚：
$$
r_{acc}(t) = \frac{1}{U}\sum_{u=1}^{U}\frac{\|\mathbf{a}_u(t)\|^2}{A_{max}^2 + \epsilon}
$$

**f) 能耗项:**
$$
r_{energy}(t) = - \frac{1}{U} \sum_{u=1}^{U} \frac{P_{fly, u}(t) + P_{comm, u}(t)}{P_{max}^{UAV}}
$$

**g) 总奖励函数（含饱和非线性）:**
$$
r_{raw}(t) = \eta_{service}\cdot S_{norm}(t) - \eta_{drop}\cdot D_{norm}(t) - \omega_Q \cdot r_{queue}(t) + \eta_{\Delta q}\cdot\Delta Q(t) - \eta_{acc}\cdot r_{acc}(t) + \omega_E \cdot r_{energy}(t)
$$
为避免奖励过大导致优化不稳定，使用 $\tanh$ 压缩，并叠加约束惩罚：
$$
r(t) = \tanh\left(r_{raw}(t)\right) + \Psi_{fail}(t)
$$
其中 $\eta_{service}, \eta_{drop}, \omega_Q, \eta_{\Delta q}, \eta_{acc}, \omega_E$ 为权重因子，且通常 $\eta_{crash} \gg \omega_Q > \omega_E$，以确保安全性优先于性能优化。

**h) 优化目标:**
基于定义的单步奖励 $r(t)$ 和折扣因子 $\gamma$，多智能体系统的协同目标是最大化期望折扣累积回报。智能体 $u$ 的策略 $\pi_\theta$ 旨在最大化以下目标函数：
$$
J(\theta) = \mathbb{E}_{\pi} \left[ \sum_{t=0}^{T} \gamma^t r(t) \right]
$$

